---
- hosts: all
  become: yes
  tasks:
    - name: Install snap
      apt:
        name: snapd
        state: latest
        update_cache: true

    - name: Install microk8s
      snap:
        name: microk8s
        classic: yes

    - name: Get microk8s status
      shell: microk8s status --format short
      changed_when: false
      register: microk8s_status

    - name: Enable DNS
      command: microk8s enable helm3
      when: '"helm3: enabled" not in microk8s_status.stdout_lines'

    - name: Create kubectl config
      become: yes
      changed_when: true
      shell: microk8s config > $HOME/.kube/config

    - name: Fetch kubeconfig
      fetch:
        src: ~/.kube/config
        dest: /tmp/microk8s-kubeconfig
        flat: yes
